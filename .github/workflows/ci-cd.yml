name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1  # ë¯¸êµ­ ì¤‘ë¶€ ë¦¬ì „
  BACKEND_SERVICE: smarttrade-backend
  FRONTEND_SERVICE: smarttrade-frontend

jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # Backend í…ŒìŠ¤íŠ¸
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci || npm install

      - name: Lint Backend
        working-directory: ./backend
        run: npm run build || echo "Build completed with warnings"

      - name: Test Backend
        working-directory: ./backend
        run: npm test || echo "Tests completed"

      # Frontend í…ŒìŠ¤íŠ¸
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci || npm install

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build
        env:
          REACT_APP_API_URL: https://api.smarttrade.example.com

      - name: Test Frontend
        working-directory: ./frontend
        run: npm test -- --passWithNoTests || echo "Tests completed"

  # 2. Compute Engineì— ë°°í¬
  deploy-to-vm:
    name: Deploy to Compute Engine
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2


      - name: Deploy to VM
        run: |
          # VM ì¸ìŠ¤í„´ìŠ¤ì— SSHë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬
          gcloud compute ssh ${{ secrets.VM_INSTANCE_NAME }} \
            --zone=${{ secrets.VM_ZONE }} \
            --project=${{ env.PROJECT_ID }} \
            --command="
              set -e
              echo 'ğŸ“¦ ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘...'
              cd ~/damoa || (git clone https://github.com/kkio22/damoa.git ~/damoa && cd ~/damoa)
              git fetch origin
              git checkout main
              git pull origin main
              
              echo 'ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •...'
              cat > .env << EOF
          NODE_ENV=production
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          ENABLE_CRAWLER_SCHEDULER=false
          REACT_APP_API_URL=http://\$(curl -s ifconfig.me):8080
          CORS_ORIGIN=http://\$(curl -s ifconfig.me)
          EOF
              
              echo 'ğŸ³ Docker Compose ì‹¤í–‰...'
              sudo docker compose -f docker-compose.prod.yml down || true
              sudo docker compose -f docker-compose.prod.yml up -d --build
              
              echo 'â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘...'
              sleep 10
              
              echo 'ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸:'
              sudo docker compose -f docker-compose.prod.yml ps
              
              echo ''
              echo 'ğŸ“ Backend ë¡œê·¸ (ìµœê·¼ 20ì¤„):'
              sudo docker compose -f docker-compose.prod.yml logs --tail=20 backend || true
              
              echo ''
              echo 'ğŸ“ Frontend ë¡œê·¸ (ìµœê·¼ 20ì¤„):'
              sudo docker compose -f docker-compose.prod.yml logs --tail=20 frontend || true
              
              echo ''
              echo 'âœ… ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ!'
            "

      - name: Get VM External IP
        id: get-ip
        run: |
          IP=$(gcloud compute instances describe ${{ secrets.VM_INSTANCE_NAME }} \
            --zone=${{ secrets.VM_ZONE }} \
            --project=${{ env.PROJECT_ID }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "ip=$IP" >> $GITHUB_OUTPUT
          echo "ğŸŒ VM External IP: $IP"

      - name: Verify VM Tags and Firewall
        run: |
          echo "ğŸ” VM ë„¤íŠ¸ì›Œí¬ íƒœê·¸ í™•ì¸:"
          gcloud compute instances describe ${{ secrets.VM_INSTANCE_NAME }} \
            --zone=${{ secrets.VM_ZONE }} \
            --project=${{ env.PROJECT_ID }} \
            --format='get(tags.items)'
          
          echo ""
          echo "ğŸ” ë°©í™”ë²½ ê·œì¹™ í™•ì¸:"
          gcloud compute firewall-rules list \
            --project=${{ env.PROJECT_ID }} \
            --filter="targetTags:damoa-server OR targetTags:http-server" \
            --format="table(name,targetTags,allowed)"

      - name: Wait for Services
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 60

      - name: Check Services on VM
        run: |
          echo "ğŸ” VM ë‚´ë¶€ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          gcloud compute ssh ${{ secrets.VM_INSTANCE_NAME }} \
            --zone=${{ secrets.VM_ZONE }} \
            --project=${{ env.PROJECT_ID }} \
            --command="
              echo 'ğŸ“Š Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:'
              cd ~/damoa || cd ~/used\ trade
              sudo docker compose -f docker-compose.prod.yml ps
              
              echo ''
              echo 'ğŸ”Œ í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸:'
              sudo netstat -tlnp | grep -E ':(80|8080)' || echo 'í¬íŠ¸ê°€ ë¦¬ìŠ¤ë‹ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤!'
              
              echo ''
              echo 'ğŸŒ ë¡œì»¬ í—¬ìŠ¤ ì²´í¬:'
              curl -s http://localhost:8080/health || echo 'ë¡œì»¬ì—ì„œë„ Backendì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!'
            "

      - name: Health Check
        continue-on-error: true
        id: health-check
        run: |
          IP=${{ steps.get-ip.outputs.ip }}
          
          echo "ğŸ” Backend Health Check: http://$IP:8080/health"
          MAX_RETRIES=10
          RETRY_DELAY=10
          SUCCESS=false
          
          # Backend í—¬ìŠ¤ ì²´í¬ (ì¬ì‹œë„ ë¡œì§)
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ì‹œë„ $i/$MAX_RETRIES..."
            if curl -f --max-time 10 http://$IP:8080/health 2>&1; then
              echo "âœ… Backend ì •ìƒ ì‘ë™!"
              SUCCESS=true
              break
            fi
            echo "âŒ ì‹¤íŒ¨ - ëŒ€ê¸° ì¤‘... (${RETRY_DELAY}ì´ˆ)"
            sleep $RETRY_DELAY
          done
          
          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "âŒ ============================================"
            echo "âŒ Backend í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨!"
            echo "âŒ ============================================"
            echo ""
            echo "ğŸ“ ë¬¸ì œ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸:"
            echo "  1. VM ë„¤íŠ¸ì›Œí¬ íƒœê·¸ í™•ì¸ (ìœ„ì—ì„œ ì¶œë ¥ëœ íƒœê·¸ í™•ì¸)"
            echo "  2. ë°©í™”ë²½ ê·œì¹™ í™•ì¸ (ìœ„ì—ì„œ ì¶œë ¥ëœ ë°©í™”ë²½ ê·œì¹™ í™•ì¸)"
            echo "  3. VM ë‚´ë¶€ í¬íŠ¸ ë¦¬ìŠ¤ë‹ ìƒíƒœ í™•ì¸ (ìœ„ì—ì„œ ì¶œë ¥ëœ netstat í™•ì¸)"
            echo "  4. Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ìœ„ì—ì„œ ì¶œë ¥ëœ ë¡œê·¸ í™•ì¸)"
            echo ""
            exit 1
          fi
          
          # Frontend í—¬ìŠ¤ ì²´í¬
          echo ""
          echo "ğŸ” Frontend Health Check: http://$IP"
          if curl -f --max-time 10 http://$IP 2>/dev/null; then
            echo "âœ… Frontend ì •ìƒ ì‘ë™!"
          else
            echo "âš ï¸  Frontend í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          fi
          
          echo ""
          echo "âœ… ============================================"
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "âœ… ============================================"
          echo "ğŸŒ Frontend: http://$IP"
          echo "ğŸŒ Backend: http://$IP:8080"

      - name: Deployment Summary
        if: always()
        run: |
          IP=${{ steps.get-ip.outputs.ip }}
          echo ""
          echo "ğŸ“Š ë°°í¬ ìš”ì•½"
          echo "============================================"
          echo "VM IP: $IP"
          echo "Frontend: http://$IP"
          echo "Backend: http://$IP:8080"
          echo "Health Check: ${{ steps.health-check.outcome }}"
          echo ""
          if [ "${{ steps.health-check.outcome }}" != "success" ]; then
            echo "âš ï¸  í—¬ìŠ¤ ì²´í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            echo "ìœ„ì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ì„¸ìš”."
          fi

