# GitHub Actions - í¬ë¡¤ë§ ìë™ íŠ¸ë¦¬ê±°
# ë§¤ì¼ ìì •ì— ìë™ìœ¼ë¡œ í¬ë¡¤ë§ì„ ì‹¤í–‰í•©ë‹ˆë‹¤

name: Daily Crawling Trigger

on:
  # ë§¤ì¼ ìì • (UTC 15:00 = KST 00:00)
  schedule:
    - cron: '0 15 * * *'
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±° (GitHub Actions íƒ­ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
  workflow_dispatch:
    inputs:
      platform:
        description: 'í¬ë¡¤ë§í•  í”Œë«í¼'
        required: true
        default: 'daangn'
        type: choice
        options:
          - daangn
          - joonggo
          - bunjang
      locations:
        description: 'í¬ë¡¤ë§í•  ì§€ì—­ (ì‰¼í‘œë¡œ êµ¬ë¶„)'
        required: false
        default: 'ì—­ì‚¼ë™,ë…¼í˜„ë™,ì••êµ¬ì •ë™,ì²­ë‹´ë™'

jobs:
  trigger-crawling:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Trigger Crawling
        env:
          API_URL: ${{ secrets.API_URL }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "ğŸš€ í¬ë¡¤ë§ íŠ¸ë¦¬ê±° ì‹œì‘..."
          
          # í¬ë¡¤ë§ íŠ¸ë¦¬ê±° API í˜¸ì¶œ
          response=$(curl -X POST "$API_URL/api/crawling/trigger" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -d '{
              "platform": "${{ github.event.inputs.platform || 'daangn' }}",
              "locations": ["ì—­ì‚¼ë™", "ë…¼í˜„ë™", "ì••êµ¬ì •ë™", "ì²­ë‹´ë™", "ì‚¼ì„±ë™", "ëŒ€ì¹˜ë™"]
            }' \
            -w "\n%{http_code}" -s)
          
          # HTTP ìƒíƒœ ì½”ë“œ ì¶”ì¶œ
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 202 ] || [ "$http_code" -eq 200 ]; then
            echo "âœ… í¬ë¡¤ë§ íŠ¸ë¦¬ê±° ì„±ê³µ!"
            echo "$body" | jq '.'
          else
            echo "âŒ í¬ë¡¤ë§ íŠ¸ë¦¬ê±° ì‹¤íŒ¨!"
            exit 1
          fi

      - name: Wait for Crawling
        run: |
          echo "â³ í¬ë¡¤ë§ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          sleep 300  # 5ë¶„ ëŒ€ê¸°

      - name: Check Crawling Status
        env:
          API_URL: ${{ secrets.API_URL }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "ğŸ“Š í¬ë¡¤ë§ ìƒíƒœ í™•ì¸..."
          
          response=$(curl -X GET "$API_URL/api/crawling/status" \
            -H "Authorization: Bearer $API_KEY" \
            -s)
          
          echo "$response" | jq '.'
          
          total_products=$(echo "$response" | jq -r '.data.currentData.totalProducts')
          echo "ì´ ìƒí’ˆ ìˆ˜: $total_products"

      - name: Send Notification
        if: always()
        run: |
          echo "ğŸ“¨ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"
          # ìŠ¬ë™, ë””ìŠ¤ì½”ë“œ, ì´ë©”ì¼ ë“±ìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡ ê°€ëŠ¥

